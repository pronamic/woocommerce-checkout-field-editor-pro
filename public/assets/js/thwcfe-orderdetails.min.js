function thwcfeRemoveUploaded(elm,event){thwcfe_public_file_upload.remove_uploaded(elm,event)}function thwcfeChangeUploaded(elm,event){thwcfe_public_file_upload.change_uploaded(elm,event)}var thwcfe_public_file_upload=function($,window,document){"use strict";function setup_file_upload(wrapper,data){setup_preview_on_page_load(wrapper,data),wrapper.find(".thwcfe-checkout-file").on("change",upload_file)}function setup_preview_on_page_load(form,data){form.find("input.thwcfe-checkout-file-value").each(function(){var wrapper=$(this).closest(".thwcfe-input-field-wrapper");if($(this).val())try{var files=JSON.parse($(this).val());if(Array.isArray(files))return void clean_file_input(wrapper);if(files&&0===Object.keys(files).length&&files.constructor===Object)clean_file_input(wrapper);else{var prev_html="";$.each(files,function(n,file){prev_html+=prepare_preview_html(file)});wrapper.find(".thwcfe-remove-uploaded").show(),wrapper.find(".thwcfe-upload-preview").html(prev_html),wrapper.find(".thwcfe-uloaded-files").show(),thwcfe_public_var.show_file_upload_button_after_upload?wrapper.find(".thwcfe-checkout-file").show():(wrapper.find(".thwcfe-checkout-file").hide(),wrapper.find(".thwcfe-btn-file-upload").hide())}}catch(e){clean_file_input(wrapper)}})}function upload_file(event){var files=event.target.files,wrapper=($("#"+event.target.id).parent(),$(this).closest(".thwcfe-input-field-wrapper")),input=wrapper.find(".thwcfe-checkout-file-value"),prev_value=input.val(),field_name=input.attr("name"),nonce=input.attr("data-nonce"),data=new FormData,uploaded_size=0;data.append("action","thwcfe_file_upload"),data.append("field_name",field_name),data.append("security",nonce),data.append("prev_value",prev_value),$.each(files,function(key,value){data.append("file[]",value),uploaded_size+=value.size});var wp_max_upload_size=parseInt(thwcfe_public_var.wp_max_upload_size);if(uploaded_size>wp_max_upload_size){var data={response:"ERROR",error:thwcfe_public_var.wp_max_upload_size_warning};return add_message(wrapper,data,"error"),void clean_file_input(wrapper)}$.ajax({type:"POST",url:thwcfe_public_var.ajax_url,data:data,cache:!1,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){wrapper.find(".thwcfe-file-upload-status").show(),input.val(""),clear_message(wrapper)}}).done(function(data,textStatus,jqXHR){show_uploaded_files(data,input,wrapper)}).fail(function(jqXHR,textStatus,error){add_message(wrapper,data,"error"),clean_file_input(wrapper)}).always(function(){wrapper.find(".thwcfe-file-upload-status").hide()})}function show_uploaded_files(data,input,wrapper){if(!$.isEmptyObject(data)){var prev_html="",filenames=[],uploaded_obj={},error_data="";$.each(data,function(index,rdata){var filenames_arr=[];if("SUCCESS"==rdata.response){var uploaded=rdata.uploaded;if(uploaded){$(uploaded).each(function(index,uploaded_item){var item_name=uploaded_item.name;item_name&&-1==$.inArray(item_name,filenames_arr)&&filenames_arr.push(item_name)}),filenames_arr.length&&filenames.push(filenames_arr.toString()),uploaded_obj[uploaded.name]=uploaded,prev_html+=prepare_preview_html(uploaded),clean_file_input(wrapper),input.val(JSON.stringify(uploaded_obj)),input.attr("data-file-name",filenames.join(", "));wrapper.find(".thwcfe-remove-uploaded").show(),wrapper.find(".thwcfe-upload-preview").html(prev_html),wrapper.find(".thwcfe-uloaded-files").show(),thwcfe_public_var.show_file_upload_button_after_upload?wrapper.find(".thwcfe-checkout-file").show():(wrapper.find(".thwcfe-checkout-file").hide(),wrapper.find(".thwcfe-btn-file-upload").hide())}}else{error_data+="<br>"+index+" - "+rdata.error;add_message(wrapper,{response:"ERROR",error:error_data},"error"),clean_file_input(wrapper)}}),input.trigger("change")}}function prepare_preview_html(uploaded){var file_size="";$.isNumeric(uploaded.size)&&(file_size=uploaded.size/1e3,file_size=Math.round(file_size),file_size+=" KB");var prev_html='<span class="thwcfe-uloaded-file-list"><span class="thwcfe-uloaded-file-list-item">';return prev_html+='<span class="thwcfe-columns">',-1!==$.inArray(uploaded.type,IMG_FILE_TYPES)&&(prev_html+='<span class="thwcfe-column-thumbnail">',prev_html+='<a href="'+uploaded.url+'" target="_blank"><img src="'+uploaded.url+'" ></a>',prev_html+="</span>"),prev_html+='<span class="thwcfe-column-title">',prev_html+='<span title="'+uploaded.name+'" class="title"><a href="'+uploaded.url+'" target="_blank">'+uploaded.name+"</a></span>",file_size&&(prev_html+='<span class="size">'+file_size+"</span>"),prev_html+="</span>",prev_html+='<span class="thwcfe-column-actions">',prev_html+='<a href="#" onclick="thwcfeRemoveUploaded(this, event); return false;" class="thwcfe-action-btn thwcfe-remove-uploaded" title="Remove" data-file="'+uploaded.file+'">X</a>',prev_html+="</span>",prev_html+="</span>",prev_html+="</span></span>"}function remove_uploaded(elm,event){var wrapper=$(elm).closest(".thwcfe-input-field-wrapper"),file=($(elm).closest(".thwcfe-uloaded-file-list"),$(elm).data("file")),field_name=$(wrapper).find("input.thwcfe-checkout-file-value").attr("name"),file_names=$(wrapper).find("input.thwcfe-checkout-file-value").attr("data-file-name"),file_names_arr=file_names.split(","),uploaded_val=$(wrapper).find("input.thwcfe-checkout-file-value").val(),nonce=$(wrapper).find("input.thwcfe-checkout-file-value").attr("data-nonce"),data={action:"thwcfe_remove_uploaded",user_id:thwcfe_public_var.user_id,field_name:field_name,security:nonce,file:file};$.ajax({type:"POST",url:thwcfe_public_var.ajax_url,data:data,cache:!1,dataType:"json",beforeSend:function(){wrapper.find(".thwcfe-uloaded-files").hide(),wrapper.find(".thwcfe-file-upload-status").show(),clear_message(wrapper)}}).done(function(data,textStatus,jqXHR){if("SUCCESS"==data.response){clear_uploaded(elm,wrapper);var UploadedVal=JSON.parse(uploaded_val);for(var f_key in UploadedVal)if(UploadedVal.hasOwnProperty(f_key)){var FileVal=UploadedVal[f_key];if(FileVal.hasOwnProperty("file")&&FileVal.file==file){delete UploadedVal[f_key];var file_name_key=file_names_arr.indexOf(f_key);file_names_arr.splice(file_name_key,1)}}UploadedVal&&0===Object.keys(UploadedVal).length&&UploadedVal.constructor===Object?clean_file_input(wrapper):($(wrapper).find("input.thwcfe-checkout-file-value").val(JSON.stringify(UploadedVal)),$(wrapper).find("input.thwcfe-checkout-file-value").attr("data-file-name",file_names_arr.join(", ")),$(wrapper).find("input.thwcfe-checkout-file-value").trigger("change"))}}).fail(function(jqXHR,textStatus,error){wrapper.find(".thwcfe-uloaded-files").show(),add_message(wrapper,error,"error")}).always(function(){wrapper.find(".thwcfe-file-upload-status").hide()})}function clear_uploaded(elm,wrapper){$(elm).data("file",""),$(elm).hide();var upload_list=$(elm).closest(".thwcfe-uloaded-file-list");wrapper.find(".thwcfe-uloaded-file-list").length<=1?(clean_file_input(wrapper),wrapper.find(".thwcfe-upload-preview").html(""),wrapper.find(".thwcfe-uloaded-files").hide(),wrapper.find(".thwcfe-checkout-file").show(),wrapper.find(".thwcfe-btn-file-upload").show()):(wrapper.find(".thwcfe-uloaded-files").show(),upload_list.remove())}function change_uploaded(elm,event){var wrapper=$(elm).closest(".thwcfe-input-field-wrapper");wrapper.find(".thwcfe-remove-uploaded").hide(),wrapper.find(".thwcfe-input-file").show()}function clean_file_input(wrapper){var input=wrapper.find(".thwcfe-checkout-file-value");wrapper.find(".thwcfe-checkout-file").val(""),input.val(""),input.attr("data-file-name",""),input.trigger("change")}function add_message(wrapper,data,type){data.response&&data.error?(wrapper.find(".thwcfe-file-upload-msg").html(data.error),wrapper.find(".thwcfe-file-upload-msg").show()):clear_message(wrapper)}function clear_message(wrapper){wrapper.find(".thwcfe-file-upload-msg").html(""),wrapper.find(".thwcfe-file-upload-msg").hide()}var IMG_FILE_TYPES=["image/jpg","image/png","image/gif","image/jpeg"];return{setup_file_upload:setup_file_upload,remove_uploaded:remove_uploaded,change_uploaded:change_uploaded,prepare_preview_html:prepare_preview_html,clean_file_input:clean_file_input}}(window.jQuery,window,document),thwcfe_order_details=function($){"use strict";function initialize_thwcfe_orderdetails(){var form_wrapper=$("#post");form_wrapper&&thwcfe_public_file_upload.setup_file_upload(form_wrapper,thwcfe_public_var)}return initialize_thwcfe_orderdetails(),{initialize_thwcfe_orderdetails:initialize_thwcfe_orderdetails}}(jQuery);